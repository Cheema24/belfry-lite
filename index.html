<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Belfry 0.2 - Belfry Prime (Front-end)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root{
    --bg-dark: #0b0b0f;
    --panel-dark: #151518;
    --accent: #2ea8e5;
    --muted: #9aa0a6;
    --white: #ffffff;
    --purple: #b46eff;
  }

  html,body{height:100%;margin:0;}
  body{
    font-family: Inter, Arial, Helvetica, sans-serif;
    background:var(--bg-dark);
    color:var(--white);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  #app{display:none; height:100%; width:100%; box-sizing:border-box;}

/* top bar */
  header{
    display:flex;
    gap:12px;
    align-items:center;
    padding:10px 14px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-bottom:1px solid rgba(255,255,255,0.03);
  }
  header h1{font-size:18px; margin:0; font-weight:600;}
  .status {
    margin-left:auto;
    display:flex;
    gap:10px;
    align-items:center;
    color:var(--muted);
    font-size:13px;
  }
  .pill{
    padding:6px 10px;
    border-radius:8px;
    background:var(--panel-dark);
    border:1px solid rgba(255,255,255,0.03);
    display:inline-flex;
    gap:8px;
    align-items:center;
  }

/* layout */
  .layout{display:grid; grid-template-columns: 360px 1fr; height:calc(100% - 56px);}
  .left{
    padding:12px; box-sizing:border-box;
    background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);
    border-right:1px solid rgba(255,255,255,0.03);
    overflow:auto;
  }
  .mapWrap{position:relative;}
  #map{height:100%; width:100%;}

/* controls */
  .control-row{display:flex; gap:8px; align-items:center; margin-bottom:10px;}
  label.inline{display:inline-flex; gap:8px; align-items:center; font-size:14px;}
  select, input[type="text"], input[list]{
    padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.06);
    background:#0e0e12; color:var(--white); outline:none; min-width:120px;
  }
  button{
    padding:8px 10px; border-radius:6px; border:none; cursor:pointer; background:var(--accent); color:#001a24;
    font-weight:600;
  }
  .muted{color:var(--muted);font-size:13px;}
  .small{font-size:13px;padding:6px 8px}

/* stats */
  .stats{margin-top:8px; padding:10px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02);}
  .stat-line{display:flex; justify-content:space-between; margin-bottom:6px; font-size:13px; color:var(--muted);}

/* plane icon (divIcon) */
  .plane-icon{
    width:28px; height:28px; display:inline-block; transform-origin:center center;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.6));
  }

/* tooltip card styling (Leaflet popups/tooltip inherit) */
  .leaflet-popup-content-wrapper{background:#111; color:var(--white)}
  .leaflet-tooltip{background:#111; border:1px solid rgba(255,255,255,0.06); color:var(--white); padding:6px 8px; border-radius:6px;}

/* search toggles */
  .toggle {display:inline-flex; align-items:center; gap:8px;}
  .muted-block{color:var(--muted); font-size:13px; margin-bottom:10px;}

  /* responsive */
  @media (max-width:900px){
    .layout{grid-template-columns:1fr; grid-template-rows: auto 1fr;}
    .left{order:2}
    .mapWrap{order:1; height:60vh}
  }
</style>
</head>
<body>

<!-- App skeleton hidden until auth -->
<div id="app">
<header>
  <h1>Belfry 0.2 ‚Äî Belfry Prime (Front-end)</h1>
  <div class="status">
    <div class="pill" id="refreshPill">üõ∞Ô∏è <span id="refreshText">Idle</span></div>
    <div class="pill muted" id="lastPill">Last: <span id="lastText">‚Äî</span></div>
  </div>
</header>

<div class="layout">
  <div class="left">
    <div class="control-row">
      <label class="inline"><input type="checkbox" id="locationToggle"> Search by location</label>
      <label class="inline muted">Refresh <select id="refreshInterval"><option>15</option><option>30</option><option>60</option></select>s</label>
    </div>

    <div class="control-row" id="locationControls" style="display:none;flex-direction:column;gap:8px">
      <div>
        <label class="muted">Continent</label><br>
        <input list="continentList" id="continentInput" placeholder="Type or pick continent (All allowed)">
        <datalist id="continentList"></datalist>
      </div>
      <div>
        <label class="muted">Country</label><br>
        <input list="countryList" id="countryInput" placeholder="Country (hidden until continent selected)" disabled>
        <datalist id="countryList"></datalist>
      </div>
      <div>
        <label class="muted">City</label><br>
        <input list="cityList" id="cityInput" placeholder="City (hidden until country selected)" disabled>
        <datalist id="cityList"></datalist>
      </div>
    </div>

    <div style="height:8px"></div>

    <div class="control-row">
      <label class="inline">Type
        <select id="typeFilter" class="small">
          <option value="all">All</option>
          <option value="commercial">Commercial</option>
          <option value="private">Private</option>
          <option value="military">Military</option>
        </select>
      </label>

      <label class="inline">Show:
        <select id="sourceFilter" class="small">
          <option value="both">Both</option>
          <option value="real">Real only</option>
          <option value="dummy">Dummy only</option>
        </select>
      </label>
    </div>

    <div class="control-row">
      <button id="mapThemeBtn" class="small">Toggle Map Theme</button>
      <button id="toggleDummyBtn" class="small">Toggle Dummy Flights</button>
      <button id="centerBtn" class="small">Center Map</button>
    </div>

    <div style="height:10px"></div>

    <div class="stats">
      <div class="stat-line"><div>Flights visible</div><div id="statCount">0</div></div>
      <div class="stat-line"><div>Commercial</div><div id="statCommercial">0</div></div>
      <div class="stat-line"><div>Private</div><div id="statPrivate">0</div></div>
      <div class="stat-line"><div>Military</div><div id="statMilitary">0</div></div>
    </div>

    <div style="height:12px"></div>
    <div class="muted-block">Tip: Toggle <b>Search by location</b>, start typing a continent, pick one, then choose a country ‚Äî city will appear after country selection. Use Refresh to simulate live "real" updates.</div>
  </div>

  <div class="mapWrap">
    <div id="map"></div>
  </div>
</div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---- Authentication: run after DOM loaded so #app exists ---- */
document.addEventListener('DOMContentLoaded', ()=>{

  // Password prompt first; nothing shown until correct
  const PASSWORD = "belfryprime";
  let attempts = 0;
  function auth(){
    const p = prompt("Enter password for Belfry 0.1:");
    if(p === null){ document.body.innerHTML = "<h2 style='color:#faa; text-align:center; margin-top:50px'>Authentication cancelled</h2>"; throw new Error("auth cancelled"); }
    if(p !== PASSWORD){
      attempts++;
      alert("Incorrect password.");
      if(attempts >= 3){ document.body.innerHTML = "<h2 style='color:red; text-align:center; margin-top:50px'>Access Denied</h2>"; throw new Error("access denied"); }
      return auth();
    }
    // success
    document.getElementById('app').style.display = 'block';
    // small welcome:
    const lastP = document.getElementById('lastText');
    lastP.textContent = new Date().toLocaleString();
  }
  auth();

  /* ---------------- Map setup ---------------- */
  const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {subdomains: 'abcd', maxZoom: 19});
  const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19});
  const map = L.map('map', {preferCanvas:true}).setView([20,0], 2);
  darkTiles.addTo(map);
  let darkMode = true;

  document.getElementById('mapThemeBtn').addEventListener('click', ()=>{
    if(darkMode){ map.removeLayer(darkTiles); lightTiles.addTo(map); darkMode = false; }
    else { map.removeLayer(lightTiles); darkTiles.addTo(map); darkMode = true; }
  });

  /* ---------------- Plane icon generator (divIcon with inline SVG)  ---------------- */
  function makePlaneHTML(color, rotateDeg=0){
    // small airplane SVG, colorizable via fill
    const svg = `
      <svg class="plane-icon" viewBox="0 0 24 24" width="28" height="28" style="transform:rotate(${rotateDeg}deg);">
        <path fill="${color}" d="M21 16v-2l-8-5V3.5a1.5 1.5 0 0 0-3 0V9L2 14v2l8-1v4l-2 .5V22l4-1 4 1v-2.5L13 19v-4l8 1z"/>
      </svg>`;
    return `<div style="width:28px;height:28px;">${svg}</div>`;
  }

  function createDivIcon(color, rotation=0){
    return L.divIcon({className:'plane-divicon', html: makePlaneHTML(color, rotation), iconSize:[28,28], iconAnchor:[14,14]});
  }

  /* ---------------- Sample Data: mixture of simulated "real" and dummy flights ----------------
     - For now, we simulate "real" flights that update their endpoint periodically (to look live)
     - Dummy flights are purple and animated along simple short paths
  ---------------------------------------------------------------------------*/
  const flights = [
    // simulated real flights (real:true). These will be "refreshed" periodically.
    {id:"R100", lat:51.47, lon:-0.45, destLat:40.6413, destLon:-73.7781, alt:34000, speed:480, type:"commercial", continent:"Europe", country:"UK", city:"London", origin:"LHR", destination:"JFK", real:true},
    {id:"R101", lat:40.6413, lon:-73.7781, destLat:33.9416, destLon:-118.4085, alt:36000, speed:500, type:"commercial", continent:"North America", country:"USA", city:"New York", origin:"JFK", destination:"LAX", real:true},
    {id:"R102", lat:24.8607, lon:67.0011, destLat:33.6844, destLon:73.0479, alt:33000, speed:460, type:"commercial", continent:"Asia", country:"Pakistan", city:"Karachi", origin:"KHI", destination:"ISB", real:true},

    // dummy flights (real:false)
    {id:"D200", lat:48.8566, lon:2.3522, destLat:41.9028, destLon:12.4964, alt:32000, speed:450, type:"commercial", continent:"Europe", country:"France", city:"Paris", origin:"CDG", destination:"FCO", real:false},
    {id:"D201", lat:35.6895, lon:139.6917, destLat:37.5665, destLon:126.9780, alt:33000, speed:470, type:"commercial", continent:"Asia", country:"Japan", city:"Tokyo", origin:"HND", destination:"ICN", real:false},
    {id:"D202", lat:-33.8688, lon:151.2093, destLat:-37.8136, destLon:144.9631, alt:34000, speed:480, type:"commercial", continent:"Australia", country:"Australia", city:"Sydney", origin:"SYD", destination:"MEL", real:false},
    {id:"D203", lat:34.0522, lon:-118.2437, destLat:37.7749, destLon:-122.4194, alt:31000, speed:420, type:"private", continent:"North America", country:"USA", city:"Los Angeles", origin:"LAX", destination:"SFO", real:false},
    {id:"D204", lat:55.7558, lon:37.6173, destLat:59.9343, destLon:30.3351, alt:30000, speed:430, type:"military", continent:"Europe", country:"Russia", city:"Moscow", origin:"SVO", destination:"LED", real:false},
  ];

  /* ---------------- State ---------------- */
  let markers = new Map();     // id -> marker object
  let polylines = new Map();   // id -> polyline
  let animHandles = new Map(); // id -> animation frame handle details

  /* --------------- Utility: interpolate --------------- */
  function lerp(a,b,t){ return a + (b-a)*t; }
  function interpCoord(start, end, t){ return [lerp(start[0], end[0], t), lerp(start[1], end[1], t)]; }

  /* ---------------- create & add markers/polylines --------------- */
  function addOrUpdateFlight(f){
    // decide whether it should show given current filters
    const sourceFilter = document.getElementById('sourceFilter').value;
    if(sourceFilter === 'real' && !f.real) return;
    if(sourceFilter === 'dummy' && f.real) return;

    const typeFilter = document.getElementById('typeFilter').value;
    if(typeFilter !== 'all' && f.type !== typeFilter) return;

    // location filter check: if toggle on, check inputs
    const locToggle = document.getElementById('locationToggle').checked;
    if(locToggle){
      const contVal = (document.getElementById('continentInput').value || '').trim();
      const countryVal = (document.getElementById('countryInput').value || '').trim();
      const cityVal = (document.getElementById('cityInput').value || '').trim();
      if(contVal && contVal.toLowerCase() !== 'all' && contVal !== '' && f.continent !== contVal) return;
      if(countryVal && countryVal.toLowerCase() !== 'all' && countryVal !== '' && f.country !== countryVal) return;
      if(cityVal && cityVal.toLowerCase() !== 'all' && cityVal !== '' && f.city !== cityVal) return;
    }

    // create or update marker
    const id = f.id;
    const start = [f.lat, f.lon];
    const dest = [f.destLat, f.destLon];

    // polyline
    let poly = polylines.get(id);
    if(!poly){
      poly = L.polyline([start, start], {color: f.real ? 'deepskyblue' : 'purple', weight:2, opacity:0.9}).addTo(map);
      polylines.set(id, poly);
    }

    // marker (divIcon showing rotated plane)
    let m = markers.get(id);
    if(!m){
      const color = f.real ? (f.type==='commercial' ? '#3aa0f2' : (f.type==='private' ? '#ffd15c' : '#ff4d4d')) : '#b46eff';
      const icon = createDivIcon(color, 0);
      m = L.marker(start, {icon: icon, rotationAngle: 0}).addTo(map);
      m.bindPopup(`<strong>${f.id}</strong><br>${f.type} ‚Äî ${f.origin} ‚Üí ${f.destination}<br>Alt: ${f.alt} ft<br>Speed: ${f.speed} mph`);
      markers.set(id, m);
    } else {
      // if exists, ensure it's on map
      if(!map.hasLayer(m)) m.addTo(map);
    }

    // start animation if dummy OR if flagged to animate (real simulated update)
    startFlightAnimation(f, m, poly);
  }

  /* ---------------- animated movement along straight line ---------------- */
  function startFlightAnimation(f, marker, poly){
    const id = f.id;
    // clear previous handle if any
    const prev = animHandles.get(id);
    if(prev && prev.cancel) prev.cancel(); // stop previous loop

    // we animate with a small loop that interpolates from start to dest and resets (looping)
    let t = Math.random(); // start at random point to avoid sync
    const speedFactor = Math.max(0.0008, 0.0006 * (f.speed/300)); // controls speed; tune as needed

    let cancelled = false;
    function cancel(){ cancelled = true; }

    function step(){
      if(cancelled) return;
      t += speedFactor;
      if(t > 1) t = 0;
      const pos = interpCoord([f.lat, f.lon], [f.destLat, f.destLon], t);
      marker.setLatLng(pos);
      poly.setLatLngs([[f.lat, f.lon], pos]);
      // rotate icon to heading
      const dx = (f.destLon - f.lon);
      const dy = (f.destLat - f.lat);
      // compute approximate heading angle
      const angle = Math.atan2(dx, dy) * 180 / Math.PI * -1; // approximate rotation
      const el = marker.getElement();
      if(el){
        const svg = el.querySelector('svg.plane-icon');
        if(svg) svg.style.transform = `rotate(${angle}deg)`;
      }
      requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
    animHandles.set(id, {cancel, id});
  }

  /* ---------------- place all flights initially ---------------- */
  function refreshAllFlights(){
    // clear everything then add according to filters
    // we do not clear animHandles because startFlightAnimation cancels existing before starting new
    markers.forEach((m, id)=>{ if(map.hasLayer(m)) map.removeLayer(m); });
    polylines.forEach((p,id)=>{ if(map.hasLayer(p)) map.removeLayer(p); });
    // keep maps but create updated entries
    flights.forEach(f => addOrUpdateFlight(f));
    updateStatsUI();
  }

  /* -------------- Stats and UI -------------- */
  function updateStatsUI(){
    // count visible markers (those on map)
    let visibleCount = 0, commercial=0, priv=0, mil=0;
    markers.forEach((m,id)=>{
      if(map.hasLayer(m)) visibleCount++;
    });
    // compute by using filtered flights
    const cont = (document.getElementById('continentInput').value || '').trim();
    const country = (document.getElementById('countryInput').value || '').trim();
    const city = (document.getElementById('cityInput').value || '').trim();
    const typeVal = document.getElementById('typeFilter').value;
    flights.forEach(f=>{
      // apply same visibility logic as addOrUpdateFlight
      const sourceFilter = document.getElementById('sourceFilter').value;
      if(sourceFilter === 'real' && !f.real) return;
      if(sourceFilter === 'dummy' && f.real) return;
      if(typeVal !== 'all' && f.type !== typeVal) return;
      if(document.getElementById('locationToggle').checked){
        if(cont && cont.toLowerCase() !== 'all' && cont !== '' && f.continent !== cont) return;
        if(country && country.toLowerCase() !== 'all' && country !== '' && f.country !== country) return;
        if(city && city.toLowerCase() !== 'all' && city !== '' && f.city !== city) return;
      }
      if(f.type === 'commercial') commercial++;
      if(f.type === 'private') priv++;
      if(f.type === 'military') mil++;
    });

    document.getElementById('statCount').textContent = Array.from(markers.values()).filter(m=>map.hasLayer(m)).length;
    document.getElementById('statCommercial').textContent = commercial;
    document.getElementById('statPrivate').textContent = priv;
    document.getElementById('statMilitary').textContent = mil;
  }

  /* ---------------- Type-ahead datalist population (hierarchical) ---------------- */
  const continentInput = document.getElementById('continentInput');
  const countryInput = document.getElementById('countryInput');
  const cityInput = document.getElementById('cityInput');
  const continentList = document.getElementById('continentList');
  const countryList = document.getElementById('countryList');
  const cityList = document.getElementById('cityList');

  function populateContinentList(){
    const arr = Array.from(new Set(flights.map(f=>f.continent))).sort();
    continentList.innerHTML = '';
    arr.forEach(v => { continentList.insertAdjacentHTML('beforeend', `<option value="${v}">`); });
  }
  function populateCountryList(cont){
    let arr = flights.filter(f => cont === '' || cont.toLowerCase()==='all' ? true : f.continent === cont).map(f=>f.country);
    arr = Array.from(new Set(arr)).sort();
    countryList.innerHTML = '';
    arr.forEach(v => { countryList.insertAdjacentHTML('beforeend', `<option value="${v}">`); });
  }
  function populateCityList(country){
    let arr = flights.filter(f => country === '' || country.toLowerCase()==='all' ? true : f.country === country).map(f=>f.city);
    arr = Array.from(new Set(arr)).sort();
    cityList.innerHTML = '';
    arr.forEach(v => { cityList.insertAdjacentHTML('beforeend', `<option value="${v}">`); });
  }

  // toggle search by location
  document.getElementById('locationToggle').addEventListener('change', (e)=>{
    const on = e.target.checked;
    const container = document.getElementById('locationControls');
    if(on){
      container.style.display = 'flex';
      populateContinentList();
    } else {
      container.style.display = 'none';
      continentInput.value = ''; countryInput.value = ''; cityInput.value = '';
    }
    refreshAllFlights();
  });

  continentInput.addEventListener('input', ()=>{
    const v = continentInput.value || '';
    if(v === '' || v.toLowerCase()==='all'){ countryInput.value=''; countryInput.disabled = true; cityInput.value=''; cityInput.disabled = true; }
    else { countryInput.disabled = false; populateCountryList(v); }
    refreshAllFlights();
  });

  countryInput.addEventListener('input', ()=>{
    const v = countryInput.value || '';
    if(v === '' || v.toLowerCase()==='all'){ cityInput.value=''; cityInput.disabled = true; }
    else { cityInput.disabled = false; populateCityList(v); }
    refreshAllFlights();
  });

  cityInput.addEventListener('input', ()=> refreshAllFlights());
  document.getElementById('typeFilter').addEventListener('change', ()=> refreshAllFlights());
  document.getElementById('sourceFilter').addEventListener('change', ()=> refreshAllFlights());

  // center map button
  document.getElementById('centerBtn').addEventListener('click', ()=> map.setView([20,0],2));

  /* ---------------- Simulated "real" update loop ----------------
     - refreshInterval controls how often we change destinations for 'real' flights
  */
  let refreshIntervalSeconds = parseInt(document.getElementById('refreshInterval').value,10) || 15;
  document.getElementById('refreshInterval').addEventListener('change', (e)=>{
    refreshIntervalSeconds = parseInt(e.target.value,10) || 15;
    startAutoRefresh();
  });

  let refreshHandle = null;
  const refreshPill = document.getElementById('refreshText');
  const lastText = document.getElementById('lastText');

  function simulateRealFlightUpdates(){
    // pick "real" flights and jitter their destLat/destLon slightly to simulate movement from source
    flights.forEach(f=>{
      if(f.real){
        // small random drift for destination
        const jitter = ()=> (Math.random()-0.5) * 2.0; // ~ +/-1 degree
        f.destLat = f.destLat + jitter()*0.6;
        f.destLon = f.destLon + jitter()*0.6;
        // optionally vary speed slightly
        f.speed = Math.max(250, f.speed + (Math.random()-0.5)*20);
      }
    });
    // update UI status
    const now = new Date();
    lastText.textContent = now.toLocaleTimeString();
    refreshPill.textContent = `Updating every ${refreshIntervalSeconds}s`;
    // re-draw flights (markers animate continue but we recreate if needed)
    refreshAllFlights();
  }

  function startAutoRefresh(){
    if(refreshHandle) clearInterval(refreshHandle);
    refreshHandle = setInterval(() => {
      simulateRealFlightUpdates();
    }, refreshIntervalSeconds * 1000);
    // run immediately once
    simulateRealFlightUpdates();
  }

  // start initial load
  refreshAllFlights();
  startAutoRefresh();

  /* cleanup on unload */
  window.addEventListener('beforeunload', ()=>{
    if(refreshHandle) clearInterval(refreshHandle);
    animHandles.forEach(h => { if(h && h.cancel) h.cancel(); });
  });

}); // end DOMContentLoaded
</script>
</body>
</html>
